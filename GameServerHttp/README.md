# 
Slot游戏服务器，使用Gin+Redis+PostgreSQL

## 需求文档

### Club（俱乐部）
- 代表一个独立的资金池或平台，用户在此进行游戏活动
- 管理自己的资金系统：Bank（银行余额）、Fund（奖池资金）、Lock（锁定存款）
- 设定游戏规则参数：Rate（奖池率）、MRTP（主要返还玩家比率）

### User（用户）
- 系统中的注册玩家，可以参与多个俱乐部
- 拥有基本信息（UID、Email、Name等）和全局访问权限（GAL）
- 通过Props结构维护在各俱乐部的属性（钱包余额、访问权限等）

### Story（游戏故事）
- 表示用户在特定俱乐部打开的一个游戏实例
- 包含游戏的基本信息：GID（游戏ID）、Alias（游戏类型）、关联的CID（俱乐部ID）和UID（用户ID）
- 代表游戏的基础身份信息

### Scene（游戏场景）
- 扩展自Story，包含完整的游戏运行环境
- 增加了SID（最新旋转ID）来追踪游戏进度
- 包含Game（游戏实例）存储实际游戏状态和逻辑

### 关系图示
```
+--------+       +-----------+       +--------+       +--------+
|  Club  |<----->|   Props   |<----->|  User  |<----->|  Story |
+--------+       +-----------+       +--------+       +--------+
    ^                                     ^                |
    |                                     |                |
    +-------------------------------------+----------------+
                   |
                   v
              +----------+
              |  Scene   |
              +----------+
                   |
                   v
              +----------+
              |   Game   |
              +----------+
```

### 游戏流程

1. **用户登录与身份验证**
   - 用户登录系统，系统验证身份
   - 通过`GetAdmin`或`MustAdmin`函数获取用户信息和权限

2. **加入俱乐部**
   - 用户选择一个俱乐部参与
   - 系统检查用户在该俱乐部的Props（属性）
   - 如果是首次加入，创建新的Props记录

3. **启动游戏**
   - 用户选择游戏类型（Alias）
   - 系统创建一个新的Story实例，分配GID
   - 根据游戏类型创建Game实例，形成Scene
   - 通过`GetScene`函数加载或初始化游戏场景

4. **游戏进行**
   - 用户进行下注并旋转（增加SID计数）
   - 系统根据游戏规则和RTP计算结果
   - 每次旋转记录在Spinlog中
   - 如有特殊玩法（如倍数游戏），记录在Multlog中

5. **结算处理**
   - 根据游戏结果计算获胜金额
   - 更新用户钱包余额
   - 更新俱乐部的Bank和Fund余额
   - 记录交易日志（Walletlog和Banklog）

6. **RTP控制机制**
   - 游戏结果受RTP（返还玩家比率）影响
   - RTP优先级：用户个人RTP > 俱乐部RTP > 默认RTP
   - 通过`GetRTP`函数获取适用的RTP值

7. **资金管理**
   - 俱乐部通过`AddCash`、`AddBank`等方法管理资金
   - 用户通过`GetWallet`查询余额
   - 具有相应权限的管理员可调整用户余额和俱乐部资金

这个Slot游戏系统设计精细，能够同时处理多个俱乐部、多个用户和多个并行游戏，并通过严格的权限控制和资金管理机制确保系统的稳定运行。

## 接口文档


### linux
go build -ldflags "-X main.version=$VERSION -X 'main.buildTime=$BUILD_TIME' -X main.branch=$BRANCH -X main.commitId=$COMMIT_ID" -o bin/gateway ./gateway

nohup ./gateway --config=./gateway.yaml > /dev/null 2>&1 &
